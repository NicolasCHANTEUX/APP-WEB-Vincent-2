name: Deploy to Home Server
on:
  push:
    branches: [ "main" ]

jobs:
  deploy:
    runs-on: self-hosted
    
    steps:
    - name: ğŸšš RÃ©cupÃ©ration du code
      uses: actions/checkout@v3

    # --- NOUVEAU : On installe Node et on compile Tailwind ---
    - name: ğŸ—ï¸ Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18' # Version standard actuelle

    - name: ğŸ“¦ Install NPM & Build
      run: |
        npm install
        npm run build 
    # ---------------------------------------------------------

    - name: ğŸ“‚ Copie des fichiers
      run: |
        # On copie tout (y compris le dossier public/build gÃ©nÃ©rÃ© par npm run build)
        sudo rsync -av --exclude='.git' --exclude='.env' ./ /var/www/kayart/

    - name: ğŸ“¦ Installation des dÃ©pendances (Composer)
      run: |
        cd /var/www/kayart
        composer install --no-dev --optimize-autoloader

    - name: ğŸ”§ Permissions
      run: |
        cd /var/www/kayart
        sudo chown -R www-data:www-data writable
        sudo chown -R www-data:www-data public/uploads
        sudo chmod -R 777 writable
        sudo chmod -R 777 public/uploads

    - name: ğŸ—„ï¸ Migration Base de DonnÃ©es
      run: |
        cd /var/www/kayart
        php spark migrate