name: Deploy to Home Server
on:
  push:
    branches: [ "main" ]

jobs:
  deploy:
    runs-on: self-hosted
    
    steps:
    - name: ğŸšš RÃ©cupÃ©ration du code
      uses: actions/checkout@v3

    # --- Build Frontend (CSS/JS) ---
    - name: ğŸ—ï¸ Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18'

    - name: ğŸ“¦ Install NPM & Build Tailwind
      run: |
        rm -rf node_modules
        npm install
        # Correctif crucial pour Linux
        chmod +x node_modules/.bin/tailwindcss
        npm run build

    # --- Backup SÃ©curitÃ© (Nouveau et trÃ¨s utile) ---
    - name: ğŸ’¾ Backup de la base de donnÃ©es
      run: |
        BACKUP_DIR="/var/backups/kayart"
        sudo mkdir -p $BACKUP_DIR
        # On donne les droits au dossier backup
        sudo chmod 777 $BACKUP_DIR
        TIMESTAMP=$(date +%Y%m%d_%H%M%S)
        # J'ai corrigÃ© le nom de la base ici (boutique_en_ligne)
        # Si Ã§a demande un mot de passe et bloque, on pourra retirer cette Ã©tape plus tard
        sudo mysqldump boutique_en_ligne > $BACKUP_DIR/db_backup_$TIMESTAMP.sql || echo "âš ï¸ Backup DB Ã©chouÃ© (Non bloquant)"

    # --- Copie des fichiers ---
    - name: ğŸ“‚ Copie des fichiers
      run: |
        # On exclut les dossiers lourds et les fichiers de config locaux
        sudo rsync -av --exclude='.git' --exclude='.env' --exclude='node_modules' --exclude='vendor' ./ /var/www/kayart/

    # --- Installation PHP ---
    - name: ğŸ“¦ Installation Composer
      run: |
        cd /var/www/kayart
        composer install --no-dev --optimize-autoloader --no-interaction

    # --- Permissions (VERSION CORRIGÃ‰E 777) ---
    - name: ğŸ”§ Configuration des permissions
      run: |
        cd /var/www/kayart
        
        # CrÃ©ation des dossiers manquants (Sessions, Factures, Uploads)
        sudo mkdir -p writable/{cache,logs,session,debugbar,uploads}
        sudo mkdir -p public/writable/session
        sudo mkdir -p writable/uploads/invoices
        sudo mkdir -p public/uploads
        
        # On remet propriÃ©taire www-data (Apache)
        sudo chown -R www-data:www-data writable
        sudo chown -R www-data:www-data public/uploads
        sudo chown -R www-data:www-data public/writable

        # LA CORRECTION EST ICI : 777 au lieu de 755
        # C'est la seule faÃ§on d'Ã©viter les erreurs 500 sur ton serveur actuel
        sudo chmod -R 777 writable
        sudo chmod -R 777 public/uploads
        sudo chmod -R 777 public/writable

    # --- Nettoyage ---
    - name: ğŸ§¹ Nettoyage du cache
      run: |
        cd /var/www/kayart
        php spark cache:clear || echo "âš ï¸ Cache clear Ã©chouÃ©"

    # --- Base de DonnÃ©es ---
    - name: ğŸ—„ï¸ Migration Base de DonnÃ©es
      run: |
        cd /var/www/kayart
        php spark migrate --all

    # --- RedÃ©marrage pour HTTP/2 ---
    - name: ğŸ”„ RedÃ©marrage du serveur web
      run: |
        # On redÃ©marre Apache et PHP-FPM pour Ãªtre sÃ»r que tout est propre
        sudo systemctl reload apache2
        sudo systemctl reload php8.3-fpm || echo "Pas de FPM Ã  reload"

    - name: âœ… DÃ©ploiement terminÃ©
      run: echo "ğŸ‰ Site dÃ©ployÃ© et sÃ©curisÃ© !"