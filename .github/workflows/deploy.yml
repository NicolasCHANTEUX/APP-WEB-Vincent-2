name: Deploy to Home Server
on:
  push:
    branches: [ "main" ] # VÃ©rifie si ta branche s'appelle 'main' ou 'master'

jobs:
  deploy:
    runs-on: self-hosted # C'est Ã§a qui cible TON vieux PC
    
    steps:
    - name: ğŸšš RÃ©cupÃ©ration du code
      uses: actions/checkout@v3

    - name: ğŸ“‚ Copie des fichiers
      run: |
        # Copie tout le contenu du repo vers le dossier web
        # On exclut .git et le .env pour ne pas Ã©craser ta config serveur
        sudo rsync -av --exclude='.git' --exclude='.env' ./ /var/www/kayart/

    - name: ğŸ“¦ Installation des dÃ©pendances (Composer)
      run: |
        cd /var/www/kayart
        # Installe les librairies PHP sans les outils de dev
        composer install --no-dev --optimize-autoloader

    - name: ğŸ”§ Permissions (Dossier Writable)
      run: |
        cd /var/www/kayart
        # On donne la propriÃ©tÃ© Ã  Apache
        sudo chown -R www-data:www-data writable
        sudo chown -R www-data:www-data public/uploads
        
        # SUPER IMPORTANT : On met les droits en 777 (Lecture/Ã‰criture pour TOUT LE MONDE)
        # Cela permet Ã  ton utilisateur de lancer les migrations sans Ãªtre bloquÃ©
        sudo chmod -R 777 writable
        sudo chmod -R 777 public/uploads

    - name: ğŸ—„ï¸ Migration Base de DonnÃ©es
      run: |
        cd /var/www/kayart
        # Met Ã  jour la structure de la BDD automatiquement
        php spark migrate